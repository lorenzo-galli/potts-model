<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Modello di Potts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="wrapping.js"></script>
    <script src="potts.js"></script>
    <style>
        /* Reset e stili base */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }

        /* Contenitore principale Flexbox */
        .container {
            display: flex;
            flex-wrap: wrap;        /* allow wrapping if it overflows */
            align-items: stretch;
            justify-content: space-between;
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            box-sizing: border-box;
        }

        /* Stile comune per tutte le colonne */
        .column {
            background-color: #ffffff;
            padding: 20px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Colonne specifiche */
        .board-column {
            flex: 2; /* Colonna più grande */
        }
        .graph-column {
            flex: 1.5; /* Colonna media */
        }
        .text-column {
            flex: 1; /* Colonna più piccola */
        }

        /* Stili per gli elementi interni */
        h1, h2 {
            margin-top: 0;
            text-align: center;
        }

        canvas {
            border: 1px solid #ccc;
            width: 100%;
            height: auto;
            margin: 15px 0;
        }
        
        #chart {
             margin-bottom: 30px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 400px;
            margin: 10px 0;
            flex-wrap: wrap; /* Per migliore responsività */
        }
        .slider-container label {
            margin-right: 10px;
            white-space: nowrap;
        }
        .slider-container input[type="range"] {
            flex: 1;
            min-width: 100px; /* Larghezza minima per lo slider */
        }
        .slider-container input[type="number"] {
            margin-left: 10px;
            width: 60px;
        }

        .btn-group, button {
            margin-top: 10px;
        }

        button {
            background-color: #666;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #555;
        }

        .initial-conditions {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        p {
            line-height: 1.6;
        }

        /* Media Query per la visualizzazione mobile */
        @media (max-width: 600px) {
            .container {
                flex-direction: column;
            }
            .column {
                margin: 10px 0; /* Margine solo verticale */
            }
            /* Inverte l'ordine delle colonne per il mobile */
            .board-column { order: 1; }
            .graph-column { order: 2; }
            .text-column { order: 3; }
        }

        /* Nasconde gli spinner dei campi numerici */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="column board-column">
            <h1>Modello di Potts</h1>
            <canvas id="canvas"></canvas>
            <div class="slider-container">
                <label for="temperature">T/T<sub>c</sub>:</label>
                <input type="range" id="temperature" min="0" max="3" step="0.01" value="1"
                       oninput="document.getElementById('temperature-value').textContent = this.value; tempInput.value = this.value;">
                <span id="temperature-value">1</span>
                <input type="number" id="tempInput" min="0" max="3" step="0.01" value="1">
            </div>
            <div class="btn-group">
                <button id="play" title="Play">▶️</button>
                <button id="stop" title="Stop">⏹️</button>
                <button id="toggleGraph">Toggle Graph</button>
            </div>
        </div>

        <div class="column graph-column">
            <h2>Graph</h2>
            <canvas id="chart"></canvas>
            
            <div class="initial-conditions">
                <h2>Initial Conditions</h2>
                <div class="slider-container">
                    <label for="numColors">Q (Stati):</label>
                    <input type="range" id="numColors" min="2" max="16" step="1" value="5"
                           oninput="document.getElementById('numColors-value').textContent = this.value; numColorsInput.value = this.value;">
                    <span id="numColors-value">5</span>
                    <input type="number" id="numColorsInput" min="2" max="16" step="1" value="5">
                </div>
                <div class="slider-container">
                    <label for="boardLenght">L (Lato):</label>
                    <input type="range" id="boardLenght" min="2" max="256" step="1" value="40"
                           oninput="document.getElementById('boardLenght-value').textContent = this.value; boardLenInput.value = this.value;">
                    <span id="boardLenght-value">40</span>
                    <input type="number" id="boardLenInput" min="2" max="256" step="1" value="40">
                </div>
                <button id="trigger">Applica</button>
            </div>
        </div>

        <div class="column text-column">
            <h2>Text</h2>
            <p>"Il sistema si aggiorna ogni 50 ms più veloce e diventava un casino"</p>
        </div>

    </div>

    <script>
    // Globals
    let qCount, side, ptr, intervalId, chart, t0;

    // Wait for the WASM module to be ready
    Module.onRuntimeInitialized = () => {
      // Cache DOM handles
      const numColors   = document.getElementById('numColors');
      const boardLenEl  = document.getElementById('boardLenght');
      const tempSlider  = document.getElementById('temperature');
      const triggerBtn  = document.getElementById('trigger');

      // new keyboard inputs
      const numColorsInput = document.getElementById('numColorsInput');
      const boardLenInput  = document.getElementById('boardLenInput');
      const tempInput      = document.getElementById('tempInput');

      // keep slider ↔ text in sync
      numColorsInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          numColors.value = v;
          document.getElementById('numColors-value').textContent = v;
        }
      });
      boardLenInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          boardLenEl.value = v;
          document.getElementById('boardLenght-value').textContent = v;
        }
      });
      tempInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          tempSlider.value = v;
          document.getElementById('temperature-value').textContent = v;
        }
      });

      // 1) Read initial slider values
      qCount = +numColors.value;
      side   = +boardLenEl.value;

      // 2) Initialize the board in C/WASM and draw it
      ptr = Module.ccall(
        'init_board',          // C function name
        'number',              // return type
        ['number','number'],   // argument types
        [qCount, side]         // argument values
      );
      // Copy back side×side bytes from WASM heap into JS array
      let raw   = Module.HEAPU8.subarray(ptr, ptr + side*side);
      let board = Array.from(raw);
      init_board(side, qCount, board);  // draw initial state

      // 1) set up Chart.js
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],         // will be time in seconds
          datasets: [
            {
              label: 'Avg Energy',
              data: [],
              borderColor: 'red',
              fill: false
            },
            {
              label: 'Order Parameter',
              data: [],
              borderColor: 'blue',
              fill: false
            }
          ]
        },
        options: { animation: false }
      });

      t0 = performance.now();

      // add at top of Module.onRuntimeInitialized:
      let graphEnabled = true,
          stepCounter  = 0;

      // wire the new toggle button
      document.getElementById('toggleGraph').addEventListener('click', () => {
        graphEnabled = !graphEnabled;
        document.getElementById('chart').style.display = graphEnabled ? 'block' : 'none';
      });

      // 2) extend updateStep()
      function updateStep() {
        // a) update your model & redraw grid
        const T = Number(tempSlider.value) / Math.log(1 + Math.sqrt(qCount));
        ptr = Module.ccall('update_board','number',['number'],[T]);
        const updated = Module.HEAPU8.subarray(ptr, ptr + side*side);
        gboard = Array.from(updated);
        draw_all(gboard);

        // only every 10th call (and only if graphEnabled):
        if (graphEnabled) {
          // fetch metrics pointer
          const mptr = Module.ccall('get_metrics','number',[],[]);
          const metrics = new Float64Array(Module.HEAPF64.buffer, mptr, 2);
          const avgE  = metrics[0],
                order = metrics[1],
                t     = ((performance.now() - t0)/1000).toFixed(2);

          // push into chart
          chart.data.labels.push(t);
          chart.data.datasets[0].data.push(avgE);
          chart.data.datasets[1].data.push(order);

          // trim history if you like
          if (chart.data.labels.length > 200) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(ds => ds.data.shift());
          }
          chart.update('none');
        }
      }

      // 3) wire play/stop/slider as before, but use the new updateStep
      tempSlider.addEventListener('input', updateStep);
      tempInput .addEventListener('input', updateStep);

      intervalId = setInterval(updateStep, 50);
      document.getElementById('stop').onclick = () => { clearInterval(intervalId); intervalId = null; };
      document.getElementById('play').onclick = () => { if(!intervalId) intervalId = setInterval(updateStep,50); };

      // 4) trigger‐button re‐init also resets the chart
      triggerBtn.addEventListener('click', () => {
        qCount = +numColors.value;
        side = +boardLenEl.value;
        ptr = Module.ccall('init_board','number',['number','number'],[qCount, side]);
        let raw2   = Module.HEAPU8.subarray(ptr, ptr + side*side);
        let board2 = Array.from(raw2);
        init_board(side, qCount, board2);

        chart.data.labels = [];
        chart.data.datasets.forEach(ds => ds.data = []);
        t0 = performance.now();
      });
    };
    </script>

</body>
</html>