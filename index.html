<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Modello di Potts</title>
    <!-- add Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Script esistenti -->
    <script src="wrapping.js"></script>
    <script src="potts.js"></script>
    <style>
        /* Reset e impostazioni base */
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }
        h1, h2 {
            margin: 0 0 10px;
        }
        /* Contenitore principale due colonne */
        .container {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            box-sizing: border-box;
            max-width: 1200px;
            margin: 0 auto;
        }
        /* Colonne sinistra e destra */
        .left-col, .right-col {
            background-color: #ffffff;
            padding: 20px;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        .left-col {
            flex: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .right-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        /* Contenitore slider */
        .slider-container {
            display: flex;
            align-items: center;
            width: 100%;
            max-width: 500px;
            margin: 10px 0;
        }
        .slider-container label {
            margin-right: 10px;
            white-space: nowrap;
        }
        .slider-container input[type="range"] {
            flex: 1;
        }
        .slider-container input[type="number"] {
            margin-left: 10px;
            width: 60px;
        }
        /* Canvas */
        #canvas {
            border: 1px solid #ccc;
            margin: 20px 0;
            width: 100%;
            height: auto;
        }
        /* Pulsanti */
        .btn-group, .right-col button, .left-col button {
            margin: 5px;
        }
        button {
            background-color: #666;
            color: white;
            border: none;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #555;
        }
        /* Sezione a larghezza intera */
        .full-width {
            background-color: #ffffff;
            padding: 20px;
            margin: 10px auto;
            max-width: 1200px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        @media (max-width: 800px) {
            .container { flex-direction: column; }
            .left-col, .right-col { margin: 10px 0; }
        }
        /* Nasconde gli spinner dei numeri */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- Colonna sinistra -->
        <div class="left-col">
            <h1>Modello di Potts</h1>
            <div class="slider-container">
                <label for="temperature">Temperatura (T/T<sub>c</sub>):</label>
                <input type="range" id="temperature" min="0" max="3" step="0.01" value="1"
                       oninput="document.getElementById('temperature-value').textContent = this.value;
                                tempInput.value = this.value;">
                <span id="temperature-value"></span>
                <input type="number" id="tempInput" min="0" max="1" step="0.01" value="1">
            </div>
            <!-- your Potts‐model canvas -->
            <canvas id="canvas"></canvas>

            <!-- new: graph canvas -->
            <h2>Energy & Order vs Time</h2>
            <canvas id="chart" width="400" height="200"></canvas>

            <div class="btn-group">
                <button id="play" title="Play">▶️</button>
                <button id="stop" title="Stop">⏹️</button>
                <button id="toggleGraph">Toggle Graph</button>
            </div>
        </div>
        <!-- Colonna destra -->
        <div class="right-col">
            <h2>Cambia condizioni iniziali</h2>
            <div class="slider-container">
                <label for="numColors">Q (Numero di stati):</label>
                <input type="range" id="numColors" min="2" max="16" step="1" value="5"
                       oninput="document.getElementById('numColors-value').textContent = this.value;
                                numColorsInput.value = this.value;">
                <span id="numColors-value">5</span>
                <input type="number" id="numColorsInput" min="2" max="16" step="1" value="5">
            </div>
            <div class="slider-container">
                <label for="boardLenght">L (Dimensione reticolo):</label>
                <input type="range" id="boardLenght" min="2" max="256" step="1" value="40"
                       oninput="document.getElementById('boardLenght-value').textContent = this.value;
                                boardLenInput.value = this.value;">
                <span id="boardLenght-value">40</span>
                <input type="number" id="boardLenInput" min="2" max="256" step="1" value="40">
            </div>
            <button id="trigger">Cambia</button>
        </div>
    </div>

    <!-- Sezione TESTO -->
    <div class="full-width">
        <h2>TESTO</h2>
        <p>Inserisci qui il testo descrittivo o informativo.</p>
    </div>

    <!-- Script esistenti -->
    <script>
    // Globals
    let qCount, side, ptr, intervalId, chart, t0;

    // Wait for the WASM module to be ready
    Module.onRuntimeInitialized = () => {
      // Cache DOM handles
      const numColors   = document.getElementById('numColors');
      const boardLenEl  = document.getElementById('boardLenght');
      const tempSlider  = document.getElementById('temperature');
      const triggerBtn  = document.getElementById('trigger');

      // new keyboard inputs
      const numColorsInput = document.getElementById('numColorsInput');
      const boardLenInput  = document.getElementById('boardLenInput');
      const tempInput      = document.getElementById('tempInput');

      // keep slider ↔ text in sync
      numColorsInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          numColors.value = v;
          document.getElementById('numColors-value').textContent = v;
        }
      });
      boardLenInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          boardLenEl.value = v;
          document.getElementById('boardLenght-value').textContent = v;
        }
      });
      tempInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          tempSlider.value = v;
          document.getElementById('temperature-value').textContent = v;
        }
      });

      // 1) Read initial slider values
      qCount = +numColors.value;
      side   = +boardLenEl.value;

      // 2) Initialize the board in C/WASM and draw it
      ptr = Module.ccall(
        'init_board',          // C function name
        'number',              // return type
        ['number','number'],   // argument types
        [qCount, side]         // argument values
      );
      // Copy back side×side bytes from WASM heap into JS array
      let raw   = Module.HEAPU8.subarray(ptr, ptr + side*side);
      let board = Array.from(raw);
      init_board(side, qCount, board);  // draw initial state

      // 1) set up Chart.js
      const ctx = document.getElementById('chart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],         // will be time in seconds
          datasets: [
            {
              label: 'Avg Energy',
              data: [],
              borderColor: 'red',
              fill: false
            },
            {
              label: 'Order Parameter',
              data: [],
              borderColor: 'blue',
              fill: false
            }
          ]
        },
        options: { animation: false }
      });

      t0 = performance.now();

      // add at top of Module.onRuntimeInitialized:
      let graphEnabled = true,
          stepCounter  = 0;

      // wire the new toggle button
      document.getElementById('toggleGraph').addEventListener('click', () => {
        graphEnabled = !graphEnabled;
        document.getElementById('chart').style.display = graphEnabled ? 'block' : 'none';
      });

      // 2) extend updateStep()
      function updateStep() {
        // a) update your model & redraw grid
        const T = Number(tempSlider.value) / Math.log(1 + Math.sqrt(qCount));
        ptr = Module.ccall('update_board','number',['number'],[T]);
        const updated = Module.HEAPU8.subarray(ptr, ptr + side*side);
        gboard = Array.from(updated);
        draw_all(gboard);

        // only every 10th call (and only if graphEnabled):
        if (graphEnabled) {
          // fetch metrics pointer
          const mptr = Module.ccall('get_metrics','number',[],[]);
          const metrics = new Float64Array(Module.HEAPF64.buffer, mptr, 2);
          const avgE  = metrics[0],
                order = metrics[1],
                t     = ((performance.now() - t0)/1000).toFixed(2);

          // push into chart
          chart.data.labels.push(t);
          chart.data.datasets[0].data.push(avgE);
          chart.data.datasets[1].data.push(order);

          // trim history if you like
          if (chart.data.labels.length > 200) {
            chart.data.labels.shift();
            chart.data.datasets.forEach(ds => ds.data.shift());
          }
          chart.update('none');
        }
      }

      // 3) wire play/stop/slider as before, but use the new updateStep
      tempSlider.addEventListener('input', updateStep);
      tempInput .addEventListener('input', updateStep);

      intervalId = setInterval(updateStep, 50);
      document.getElementById('stop').onclick = () => { clearInterval(intervalId); intervalId = null; };
      document.getElementById('play').onclick = () => { if(!intervalId) intervalId = setInterval(updateStep,50); };

      // 4) trigger‐button re‐init also resets the chart
      triggerBtn.addEventListener('click', () => {
        qCount = +numColors.value;
        side = +boardLenEl.value;
        ptr = Module.ccall('init_board','number',['number','number'],[qCount, side]);
        let raw2   = Module.HEAPU8.subarray(ptr, ptr + side*side);
        let board2 = Array.from(raw2);
        init_board(side, qCount, board2);

        chart.data.labels = [];
        chart.data.datasets.forEach(ds => ds.data = []);
        t0 = performance.now();
      });
    };
    </script>

</body>
</html>