<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>daje</title>
    <!-- Emscripten‐generated glue and our renderer -->
    <script src="wrapping.js"></script>
    <script src="potts.js"></script>
    <style>
      /* hide spinner arrows on number inputs */
      input[type=number]::-webkit-inner-spin-button,
      input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
        width: 4em;
      }
    </style>
</head>
<body>
    <p>Ci si prova</p>

    <!-- Slider for number of colors Q -->
    <label for="numColors">Numero di Colori (Q):</label>
    <input
      type="range"
      id="numColors"
      min="2" max="16" step="1"
      value="5"
      oninput="
        document.getElementById('numColors-value').textContent = this.value;
        numColorsInput.value = this.value;
      "
    />
    <!-- keyboard entry -->
    <input type="number" id="numColorsInput" min="2" max="16" step="1" value="5">
    <br>

    <!-- Slider for board size L -->
    <label for="boardLenght">Lunghezza del Board (L):</label>
    <input
      type="range"
      id="boardLenght"
      min="2" max="256" step="1"
      value="40"
      oninput="
        document.getElementById('boardLenght-value').textContent = this.value;
        boardLenInput.value = this.value;
      "
    />
    <!-- keyboard entry -->
    <input type="number" id="boardLenInput" min="2" max="256" step="1" value="40">
    <br>

    <!-- Slider for temperature T/Tc -->
    <label for="temperature">Temperatura (T/Tc):</label>
    <input 
      type="range" 
      id="temperature" 
      min="0" max="3" step="0.01"
      value="1"
      oninput="
        document.getElementById('temperature-value').textContent = this.value;
        tempInput.value = this.value;
      ">
    <!-- keyboard entry -->
    <input type="number" id="tempInput" min="0" max="3" step="0.01" value="1">
    <br>

    <!-- Control buttons -->
    <button id="trigger">Trigger</button>
    <button id="play">Play</button>
    <button id="stop">Stop</button>

    <!-- Div for textual results (e.g. cluster size) -->
    <div id="result"></div>

    <!-- Canvas where the grid is drawn -->
    <canvas id="canvas"></canvas>

  <script>
    // Globals for simulation parameters and timer handle
    let qCount, side, ptr, intervalId;

    // Wait for the WASM module to be ready
    Module.onRuntimeInitialized = () => {
      // Cache DOM handles
      const numColors   = document.getElementById('numColors');
      const boardLenEl  = document.getElementById('boardLenght');
      const tempSlider  = document.getElementById('temperature');
      const triggerBtn  = document.getElementById('trigger');

      // new keyboard inputs
      const numColorsInput = document.getElementById('numColorsInput');
      const boardLenInput  = document.getElementById('boardLenInput');
      const tempInput      = document.getElementById('tempInput');

      // keep slider ↔ text in sync
      numColorsInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          numColors.value = v;
          document.getElementById('numColors-value').textContent = v;
        }
      });
      boardLenInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          boardLenEl.value = v;
          document.getElementById('boardLenght-value').textContent = v;
        }
      });
      tempInput.addEventListener('input', e => {
        let v = +e.target.value;
        if (!isNaN(v)) {
          tempSlider.value = v;
          document.getElementById('temperature-value').textContent = v;
        }
      });

      // 1) Read initial slider values
      qCount = +numColors.value;
      side   = +boardLenEl.value;

      // 2) Initialize the board in C/WASM and draw it
      ptr = Module.ccall(
        'init_board',          // C function name
        'number',              // return type
        ['number','number'],   // argument types
        [qCount, side]         // argument values
      );
      // Copy back side×side bytes from WASM heap into JS array
      let raw   = Module.HEAPU8.subarray(ptr, ptr + side*side);
      let board = Array.from(raw);
      init_board(side, qCount, board);  // draw initial state

      // 3) Define one update step: compute T, call update_board, redraw
      function updateStep() {
        const T = Number(tempSlider.value) / Math.log(1 + Math.sqrt(qCount));
        ptr = Module.ccall(
          'update_board',
          'number',
          ['number'],
          [T]
        );
        const updated = Module.HEAPU8.subarray(ptr, ptr + side*side);
        gboard = Array.from(updated);
        draw_all(gboard);
      }

      // 4) Wire the temperature slider to an immediate update
      tempSlider.addEventListener('input', updateStep);
      tempInput.addEventListener('input', updateStep);

      // 5) Start automatic updates every 50 ms
      intervalId = setInterval(updateStep, 50);

      // 6) STOP button clears the timer
      document.getElementById('stop').addEventListener('click', () => {
        clearInterval(intervalId);
        intervalId = null;  // allow Play to restart
      });

      // 7) PLAY button restarts if not already running
      document.getElementById('play').addEventListener('click', () => {
        if (!intervalId) {     // only start if we’re not already spinning
          intervalId = setInterval(updateStep, 50);
        }
      });

      // 8) trigger‐button re‐inits both C and JS globals
      triggerBtn.addEventListener('click', () => {
        qCount = +numColors.value;
        side = +boardLenEl.value;
        ptr = Module.ccall('init_board','number',['number','number'],[qCount, side]);
        let raw2   = Module.HEAPU8.subarray(ptr, ptr + side*side);
        let board2 = Array.from(raw2);
        init_board(side, qCount, board2);
      });
    };
  </script>
</body>
</html>

